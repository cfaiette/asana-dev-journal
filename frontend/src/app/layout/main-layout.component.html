<main class="layout">
  <header class="layout__header">
    <div class="layout__brand">
      <h1>Dev Journal Dashboard</h1>
      <p>Track tasks, notes, and activity from Asana</p>
    </div>
    <ng-container *ngIf="user$ | async as user; else connect">
      <div class="layout__user" aria-live="polite">
        <span class="layout__user-name">{{ user.name }}</span>
        <span class="layout__user-email">{{ user.email }}</span>
      </div>
    </ng-container>
    <ng-template #connect>
      <div class="layout__connect-buttons">
        <button type="button" class="layout__connect layout__connect--test" (click)="testBackend()">
          Test Backend
        </button>
        <button type="button" class="layout__connect" (click)="connectAsana()">
          Connect Asana
        </button>
      </div>
    </ng-template>
  </header>

  <section *ngIf="loading" class="layout__loading" role="status" aria-live="polite">
    <div class="spinner" aria-hidden="true"></div>
    <p>Loading dashboard dataâ€¦</p>
  </section>

  <section *ngIf="!loading" class="layout__content">
    <div *ngIf="toastMessage" class="layout__toast" [class.layout__toast--success]="toastSuccess" [class.layout__toast--error]="!toastSuccess" role="alert">
      {{ toastMessage }}
    </div>
    <p *ngIf="errorMessage" class="layout__error" role="alert">{{ errorMessage }}</p>

    <ng-container *ngIf="(filters$ | async) as filters">
      <ng-container *ngIf="(filterOptions$ | async) as options">
        <app-filter-panel
          [filters]="filters"
          [projects]="options.projects"
          [sections]="options.sections"
          [assignees]="options.assignees"
          [statuses]="['incomplete', 'complete', 'blocked', 'in_review', 'unknown']"
          (filtersChange)="onFiltersChange($event)"
          (clearFilters)="onClearFilters()"
        ></app-filter-panel>
      </ng-container>
    </ng-container>

    <section class="layout__main">
      <app-tab-manager
        [tabs]="(tabs$ | async) ?? []"
        [selectedTabId]="(selectedTab$ | async) ?? null"
        (tabChange)="onTabChange($event)"
      ></app-tab-manager>

      <div class="layout__grid">
        <app-task-table [tasks]="(tasks$ | async) ?? []"></app-task-table>
        <app-activity-feed [events]="(activity$ | async) ?? []"></app-activity-feed>
      </div>
    </section>
  </section>
</main>
